@inject BlazorOptions _BlazorOptions;

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">New Project: @_newProject.Name</MudText>
    </TitleContent>
    <DialogContent>
        <EditForm EditContext="@EditContext">
            <DataAnnotationsValidator/>
            <MudGrid Spacing="1">
                <MudItem lg="8" sm="12">
                    <MudTextField Variant="Variant.Outlined" T="string" Label="Name" @bind-Value="_newProject.Name" HelperText="Ex: HMLoader" For="@(() => _newProject.Name)"></MudTextField>
                </MudItem>
                <MudItem lg="4" sm="12">
                    <MudTextField HelperText="Used for ordering when using legacy loading, leave 500 if mod is in steam workshop" HelperTextOnFocus Variant="Variant.Outlined" T="int" TValue="int" Icon="info" Label="Index" @bind-Value="_newProject.ModIndex" ValidationDisabled="true"></MudTextField>
                </MudItem>
                
                <MudItem sm="10">
                    <MudTextField Variant="Variant.Outlined" T="string" Label="Assets Path" @bind-Value="_newProject.CookedAssetsPath" HelperText="Ex: C:\contoso\Mining\Saved\Cooked\WindowsNoEditor\Mining" For="@(() => _newProject.CookedAssetsPath)"></MudTextField>
                </MudItem>
                <MudItem sm="2">
                    <MudFab HtmlTag="label"
                            OnClick="@OpenCookedAssetPathDialog"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.MoreHoriz"
                            Size="Size.Large">
                    </MudFab>
                </MudItem>
                
                <MudItem sm="10">
                    <MudTextField Variant="Variant.Outlined" T="string" Label="Dist Path" @bind-Value="_newProject.OutputPath" HelperText="Ex: C:\contoso\ModDist"  For="@(() => _newProject.OutputPath)"></MudTextField>
                </MudItem>
                <MudItem sm="2">
                    <MudFab HtmlTag="label"
                            OnClick="@OpenOutputPathDialog"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.MoreHoriz"
                            Size="Size.Large">
                    </MudFab>
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@OnSubmit" >Save</MudButton>
        <MudButton OnClick="@(() => CloseDialog())">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public MudDialogInstance DialogReference { get; set; }  = null!;

    private EditContext EditContext { get; set; }  = null!;

    private readonly ProjectData _newProject = new();
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        EditContext = new EditContext(_newProject);
    }

    private void CloseDialog(bool sendResult = false)
    {
        var result = sendResult ? _newProject : null;
        
        DialogReference.Close(result);
    }

    private void OnSubmit()
    {
        if (!EditContext.Validate())
        {
            return;
        }
        
        CloseDialog(true);
    }

    private void OpenCookedAssetPathDialog()
    {
        var path = _BlazorOptions.SelectFolder("Select cooked assets path");
        
        if (path is null)
        {
            return;
        }
        
        _newProject.CookedAssetsPath = path;
    }

    private void OpenOutputPathDialog()
    {
        var path = _BlazorOptions.SelectFolder("Select dist folder path");
        
        if (path is null)
        {
            return;
        }
        
        _newProject.OutputPath = path;
    }

}